---
title: "Untitled"
output: html_document
date: "2022-12-12"
---
```{r}
#Setting up enviroment
setwd("~/Desktop/Survival Models/CW/SM-CW")
lymp.data <- read.csv("lymphoma.csv",header=T)
duck.data <- read.table("duck.txt",header = T)
library(survival) #basic functions for survival modelling
library(survminer) # package to produce much nicer visualisations
library(dplyr)

```

```{r}
## Question 1

#Computing Kaplan Meier estimate of survivor function 
lymp.km <- survfit(Surv(time,event=cens) ~ symp, data=lymp.data)

# Visualize with survminer
ggsurvplot(lymp.km, data = lymp.data)
ggsurvplot(lymp.km, data = lymp.data,conf.int =T)

#Doing it the way taught in tutorial
# Part a
summary(lymp.km)
plot(lymp.km,
     col=c("red","blue"),
     xlab = "Time (weeks)",
     ylab = "Survival probability",
     main = "Kaplan Meier survival estimates of patients \n with lymphocytic non-Hodgkins lymphoma")
legend("topright", legend = c("Asymptomatic", "Symptomatic"),
col = c("red", "blue"), lty = c(1, 1), cex = 0.8)
#Viewing the plots it is clear that the asymptomatic group has a higher survival probability than the symptomatic group for all
#time, thus those in asymptomatic group have a longer survival time than those in the symptomatic group (on average).

#Part b
#Finding CI (95%)
lymp.95 <- survfit(Surv(time,event=cens) ~ symp, data=lymp.data,conf.int=0.95)
summary(lymp.95)
#Using assumption that there are 52 weeks in a year, 6 year survival happens at week 312
#Reading off 95% confidence interval estimate at 312 weeks gives thew following 95% confidence intervals for the groups

#Asymptomatic (t>=301)
c(0.309, 0.690)
#Symptomatic (t>=281)
c(0.0156, 0.642)

#(c)
summary(lymp.km)
#For Asymptomatic time is some point greater than 301 weeks (study ended)
#For Symptomatic time is 276 weeks (drops from 0.3 to 0.2)

#Part d
lymp.na <- survfit(Surv(time,event=cens) ~ symp, data=lymp.data,type = "fleming")
par(mfrow = c(1,2))
plot(lymp.na,
     col=c("red","blue"),
     xlab = "Time (weeks)",
     ylab = "Survival probability",
     main = "Nelson-Aalen survival estimates of patients \n with lymphocytic non-Hodgkins lymphoma")
plot(lymp.km,
     col=c("red","blue"),
     xlab = "Time (weeks)",
     ylab = "Survival probability",
     main = "Kaplan Meier survival estimates of patients \n with lymphocytic non-Hodgkins lymphoma")

#Estimates are very similar, Nelson-Aalen estimates have survival portability shifted up (increased) slightly compared to Kaplan Meier
# estimates and this shift (increase in survival probability) is greater for the symptomatic group
summary(lymp.km)
summary(lymp.na)
#Survival estimates similar as d_{j}`/r_{j} small for all time for asymptomatic group (thus due to taylor approx they are approx equal)
#Survival estimates similar for symptomatic group too except at the end (due to small number at risk left) thus d_{j}`/r_{j} is not small
#so approximation is bad which is why the N-A estimates are more different for this group 


#Part e
lymp.95.na <- survfit(Surv(time,event=cens) ~ symp, data=lymp.data,conf.int=0.95,type="fleming")
summary(lymp.95.na)
#95% CI of probability of 6-year (312 week) survival for each group

#Asymptomatic (t>=301)
c( 0.319, 0.697)
#Symptomatic (t>=281)
c(0.0340, 0.621)
```


```{r}
plot(lymp.na,
     col=c("red","blue"),
     xlab = "Time (weeks)",
     ylab = "Survival probability",
     main = "Nelson-Aalen survival estimates of patients \n with lymphocytic non-Hodgkins lymphoma")
plot(lymp.km,
     col=c("red","blue"),
     xlab = "Time (weeks)",
     ylab = "Survival probability",
     main = "Kaplan Meier survival estimates of patients \n with lymphocytic non-Hodgkins lymphoma")
```

```{r}
## Question 2
#a
#USing Weibull regression models

#c
#Need to figure out if need to edit censoring
duck.data <- duck.data%>%
  mutate(Cens=abs(Observed-1))
  
duck.cox <- coxph(Surv(Time,event=Observed)~Age+Weight+Length,data=duck.data)
plot(survfit(duck.cox))
summary(duck.cox)
#Hazard of dieing increases with age (HR>1)
#Weight slightly decreases 0.004 reduction in hazard for every gram
#Length slightly increases hazard (1.0126)

#Note that none of the variables are significatnt!

# #testing alternative (looks much worse)
# duck.cox <- coxph(Surv(Time,event=Cens)~Age+Weight+Length,data=duck.data)
# plot(survfit(duck.cox))
# summary(duck.cox)

#d


#estimating the survival function using the full cox model
cox.duck.est<- survfit(duck.cox,data.frame("Age"=1,"Weight"=1000,"Length"=250))
plot(cox.duck.est, ylab= "Survival function", xlab="Time",conf.int =F)


data.frame(Age=1,Weight=1000,Length=250)
```



